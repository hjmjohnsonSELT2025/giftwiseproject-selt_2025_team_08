<div class="home-container">
  <!-- Header Section -->
  <section class="welcome-section bg-gradient py-5 mb-5">
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <h1 class="display-4 fw-bold text-white mb-3">Manage Contacts</h1>
          <p class="lead text-white-50 mb-4">Keep track of everyone you need to shop for</p>
          <%= link_to "Add a New Contact", new_contact_path, class: "btn btn-outline-solid btn-lg" %>
        </div>
      </div>
    </div>
  </section>

  <!-- Search and Filters -->
  <div class="container mb-4">
    <div class="row">
      <div class="col-12">
        <%= form_with url: contacts_path, method: :get, local: true, id: "contacts-search-form", class: "d-flex gap-2" do |f| %>
          <%= f.text_field :q, placeholder: "Search contacts by name...", class: "form-control", id: "contacts-search-input", value: params[:q] %>
          <%= f.submit "Search", class: "btn btn-outline-solid" %>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Contacts Grid -->
  <div class="container">
    <% if @contacts.any? %>
      <div class="row g-4 mb-5" id="contacts-grid">
        <% @contacts.each do |contact| %>
          <% contact_info = @contact_map[contact.id] %>
          <div class="col-lg-6 col-xl-4 contact-item" data-contact-name="<%= (contact.first_name + ' ' + contact.last_name).downcase %>">
            <div class="card shadow-sm border-0 h-100">
              <div class="accordion" id="accordion-<%= contact.id %>">
                <div class="accordion-item border-0">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-<%= contact.id %>" aria-expanded="false" aria-controls="collapse-<%= contact.id %>" style="font-weight: 500; background-color: #667eea;">
                      <i class="bi bi-person-circle me-2"></i><%= contact.first_name %> <%= contact.last_name %>
                    </button>
                  </h2>
                  <div id="collapse-<%= contact.id %>" class="accordion-collapse collapse" data-bs-parent="#accordion-<%= contact.id %>">
                    <div class="accordion-body" style="background-color: #2a2a2a; color: #e5e5e5;">
                      <div class="contact-detail mb-3">
                        <label class="text-white-50 small">Occupation</label>
                        <p class="text-white mb-0"><%= contact.occupation || "N/A" %></p>
                      </div>

                      <div class="contact-detail mb-3">
                        <label class="text-white-50 small">Age</label>
                        <p class="text-white mb-0"><%= calculate_age(contact.date_of_birth) || "N/A" %></p>
                      </div>

                      <div class="contact-detail mb-3">
                        <label class="text-white-50 small">Hobbies</label>
                        <p class="text-white small mb-0"><%= contact.hobbies || "N/A" %></p>
                      </div>

                      <div class="contact-detail mb-3">
                        <label class="text-white-50 small">Likes</label>
                        <p class="text-white small mb-0"><%= contact.likes || "N/A" %></p>
                      </div>

                      <div class="contact-detail mb-3">
                        <label class="text-white-50 small">Dislikes</label>
                        <p class="text-white small mb-0"><%= contact.dislikes || "N/A" %></p>
                      </div>

                      <div class="contact-detail mb-4">
                        <label class="text-white-50 small">Note</label>
                        <p class="text-white small mb-0" id="note-<%= contact_info.id %>"><%= contact_info.note || "No note" %></p>
                      </div>

                      <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-solid btn-sm flex-grow-1" data-bs-toggle="modal" data-bs-target="#noteModal" data-contact-id="<%= contact_info.id %>" data-contact-name="<%= contact.first_name %> <%= contact.last_name %>" data-contact-note="<%= ERB::Util.html_escape(contact_info.note || "") %>">Edit Note</button>
                        <%= button_to "Delete", contact_path(contact_info), method: :delete, data: { confirm: "Are you sure?" }, class: "btn btn-outline-danger btn-sm", style: "padding: 0.375rem 0.75rem;" %>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm border-0">
            <div class="card-body text-center py-5">
              <i class="bi bi-people text-white-50" style="font-size: 3rem;"></i>
              <p class="text-white mt-3">No contacts yet</p>
              <%= link_to "Add your first contact", new_contact_path, class: "btn btn-outline-solid mt-3" %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Edit Note Modal -->
  <div class="modal fade" id="noteModal" tabindex="-1" aria-labelledby="noteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" style="background-color: #2a2a2a; border-color: #444;">
        <div class="modal-header" style="border-bottom-color: #444;">
          <h5 class="modal-title" id="noteModalLabel" style="color: #e5e5e5;">Edit Note</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" style="color: #e5e5e5;">
          <form id="noteModalForm">
            <input type="hidden" id="noteContactId" />
            <div class="mb-3">
              <label for="noteText" class="form-label">Note</label>
              <textarea id="noteText" rows="6" placeholder="Add a note about this contact..." class="form-control" style="background-color: #1a1a1a; border-color: #444; color: #e5e5e5;"></textarea>
            </div>
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-outline-solid">Update Note</button>
              <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const searchInput = document.getElementById('contacts-search-input');
  
  if (searchInput) {
    searchInput.addEventListener('keyup', function(e) {
      const query = e.target.value.toLowerCase();
      const items = document.querySelectorAll('.contact-item');
      
      items.forEach(item => {
        const name = item.getAttribute('data-contact-name');
        item.style.display = name.includes(query) ? '' : 'none';
      });
    });
  }

  const noteModal = document.getElementById('noteModal');
  if (noteModal) {
    noteModal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      const contactId = button.getAttribute('data-contact-id');
      const contactName = button.getAttribute('data-contact-name');
      const contactNote = button.getAttribute('data-contact-note');
      
      document.getElementById('noteModalLabel').textContent = `Edit Note for ${contactName}`;
      document.getElementById('noteContactId').value = contactId;
      document.getElementById('noteText').value = contactNote || '';
    });
  }

  const noteModalForm = document.getElementById('noteModalForm');
  if (noteModalForm) {
    noteModalForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const contactId = document.getElementById('noteContactId').value;
      const noteText = document.getElementById('noteText').value;
      
      fetch(`/contacts/${contactId}/update_note`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        },
        body: JSON.stringify({ contact: { note: noteText } })
      })
      .then(response => {
        if (response.ok) {
          document.getElementById(`note-${contactId}`).textContent = noteText || 'No note';
          
          const modal = bootstrap.Modal.getInstance(noteModal);
          modal.hide();
        }
      })
      .catch(error => console.error('Error:', error));
    });
  }

  document.addEventListener('turbo:before-fetch-request', function(event) {
    if (event.target.closest('.modal')) {
      event.preventDefault();
    }
  });
</script>
