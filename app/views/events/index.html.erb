<div class="home-container">
  <!-- Welcome Section -->
  <section class="welcome-section py-5 mb-5">
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <h1 class="display-4 fw-bold text-white mb-3">Events</h1>
          <p class="lead text-white-50 mb-4">Plan and manage your gift-giving events</p>
          <div class="button-group">
            <a href="<%= new_event_path %>" class="btn btn-outline-solid btn-lg">Create Event</a>
            <a href="<%= root_path %>" class="btn btn-outline-solid btn-lg">Back to Home</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="container">
    <div class="row mb-4">
      <div class="col-12">
        <%= form_with url: events_path, method: :get, local: true do |f| %>
          <div class="input-group">
            <%= f.text_field :q, placeholder: "Search events...", class: "form-control" %>
            <button type="submit" class="btn btn-outline-solid">Search</button>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Gift Progress Card -->
    <% total_recipients_all = @events.sum { |e| e.recipients.count }
       total_gifts_all = @events.sum { |e| e.recipients.sum { |r| r.gifts_for_recipients.where(user_id: current_user.id, deleted_at: nil).count } }
       unassigned_gifts = total_recipients_all - total_gifts_all
       progress_percent = total_recipients_all > 0 ? ((total_gifts_all.to_f / total_recipients_all) * 100).round : 0 %>
    <div class="card shadow-sm border-0 mb-4" style="background-color: #2a2a2a;">
      <div class="card-body" style="background-color: #2a2a2a; padding: 1.5rem;">
        <div class="row align-items-center">
          <div class="col-md-6">
            <h5 style="color: #e5e5e5; margin-bottom: 0.5rem;">Gift Progress</h5>
            <p style="color: #999; margin-bottom: 0;">
              <strong style="color: #667eea;"><%= total_gifts_all %></strong> of <strong style="color: #667eea;"><%= total_recipients_all %></strong> gifts assigned
            </p>
          </div>
          <div class="col-md-6">
            <div class="progress" style="height: 1.5rem; background-color: #1a1a1a; border: 1px solid #444;">
              <div class="progress-bar" role="progressbar" style="width: <%= progress_percent %>%; background-color: #667eea;" aria-valuenow="<%= progress_percent %>" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <% if @events.present? %>
      <div class="accordion" id="eventsAccordion">
        <% @events.each do |event| %>
          <div class="accordion-item" style="background-color: #2a2a2a; border-color: #444; margin-bottom: 1rem;">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#event-<%= event.id %>" aria-expanded="false" aria-controls="event-<%= event.id %>" style="background-color: #667eea; color: white; font-weight: 600;">
                <%= event.name %>
              </button>
            </h2>
            <div id="event-<%= event.id %>" class="accordion-collapse collapse" data-bs-parent="#eventsAccordion">
              <div class="accordion-body" style="background-color: #1a1a1a;">
                <% if event.start_at && event.end_at %>
                  <div class="mb-3">
                    <small class="text-white-50">Date & Time</small>
                    <p class="mb-0" style="color: #ffffff;"><%= l(event.start_at, format: :short) %> - <%= l(event.end_at, format: :short) %></p>
                  </div>
                <% end %>
                
                <% if event.location.present? %>
                  <div class="mb-3">
                    <small class="text-white-50">Location</small>
                    <p class="mb-0" style="color: #ffffff;"><%= event.location %></p>
                  </div>
                <% end %>

                <% if event.theme.present? %>
                  <div class="mb-3">
                    <small class="text-white-50">Theme</small>
                    <p class="mb-0" style="color: #ffffff;"><%= event.theme %></p>
                  </div>
                <% end %>
                
                <% if event.description.present? %>
                  <div class="mb-3">
                    <small class="text-white-50">Description</small>
                    <p class="mb-0" style="color: #ffffff;"><%= event.description %></p>
                  </div>
                <% end %>

                <div class="mb-3">
                  <small class="text-white-50">Gifts</small>
                  <p class="mb-0" style="color: #ffffff;"><%= event.gift_count(current_user) %> Gifts</p>
                </div>

                <div class="d-flex gap-2 mt-3 pt-3" style="border-top: 1px solid #444;">
                  <a href="<%= event_path(event) %>" class="btn btn-outline-solid btn-sm flex-grow-1">View</a>
                  <% if event.creator_id == current_user.id %>
                    <a href="<%= edit_event_path(event) %>" class="btn btn-outline-solid btn-sm flex-grow-1">Edit</a>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="card" style="background-color: #2a2a2a; border-color: #444;">
        <div class="card-body text-center py-5">
          <p class="text-white-50 mb-3">No events yet.</p>
          <a href="<%= new_event_path %>" class="btn btn-outline-solid">Create Your First Event</a>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  if (sessionStorage.getItem('refreshEventsList') === 'true') {
    sessionStorage.removeItem('refreshEventsList');
    location.reload();
  }
  
  document.querySelectorAll('.accordion-button').forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      
      const targetId = this.getAttribute('data-bs-target');
      const targetElement = document.querySelector(targetId);
      if (targetElement) {
        const collapseInstance = bootstrap.Collapse.getOrCreateInstance(targetElement);
        collapseInstance.toggle();
      }
    });
  });
});
</script>
